<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the Inter font */
        body {
            font-family: 'Inter', sans-serif;
            /* Ensure body takes full height and has no default margin/padding */
            margin: 0;
            padding: 0;
            height: 100vh; /* Use 100vh for body to ensure it covers the whole viewport */
        }
        /* Custom active state for sidebar links (Cloudflare inspired) */
        .sidebar-link.active {
            background-color: #2563EB; /* Blue-600 */
            color: white;
            font-weight: 600;
            border-radius: 0.5rem; /* Rounded corners */
        }
        /* Hover state for sidebar links */
        .sidebar-link:hover {
            background-color: #4B5563; /* Gray-700 */
            color: white;
        }

        /* Collapsible Sidebar Styles for Desktop */
        #sidebar {
            transition: width 0.3s ease-in-out, transform 0.3s ease-in-out;
            flex-shrink: 0;
            height: 100%; /* Make sidebar take 100% height of its parent */
        }
        #main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        .sidebar-text {
            opacity: 1;
            transition: opacity 0.3s ease-in-out, width 0.3s ease-in-out;
            white-space: nowrap;
            overflow: hidden;
            width: auto;
        }

        /* Desktop Collapsed state */
        .sidebar-collapsed #sidebar {
            width: 5rem; /* w-20 */
        }
        .sidebar-collapsed #main-content {
            margin-left: 5rem; /* ml-20 */
        }
        .sidebar-collapsed .sidebar-text {
            opacity: 0;
            width: 0;
            padding-left: 0;
            padding-right: 0;
        }
        .sidebar-collapsed .sidebar-link {
            justify-content: center;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        .sidebar-collapsed .sidebar-link .mr-3 {
            margin-right: 0;
        }
        .sidebar-collapsed .profile-pic-container {
            justify-content: center;
        }
        .sidebar-collapsed .profile-pic-container .mr-3 {
            margin-right: 0;
        }

        /* Mobile-specific styles (applied below md breakpoint) */
        #sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            transform: translateX(-100%); /* Hidden by default */
            z-index: 60;
            width: 16rem;
            height: 100vh; /* Ensure full height on mobile */
        }

        #mobile-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }

        body.mobile-sidebar-open #sidebar {
            transform: translateX(0);
        }
        body.mobile-sidebar-open #mobile-backdrop {
            display: block;
        }
        body.mobile-sidebar-open #mobile-header {
            display: none;
        }

        /* Style for emoji icons to ensure consistent sizing and alignment */
        .icon-emoji {
            font-size: 1.5rem;
            line-height: 1;
            display: inline-flex; /* Use flex for centering emoji within its own space */
            align-items: center;
            justify-content: center;
            width: 1.5rem; /* Give it a fixed width for consistent alignment */
            height: 1.5rem; /* Give it a fixed height for consistent alignment */
        }

        /* Desktop overrides for mobile-specific elements (md breakpoint and above) */
        @media (min-width: 768px) { /* md breakpoint */
            #sidebar {
                position: relative; /* Back to normal flow for desktop */
                transform: translateX(0); /* Always visible on desktop */
                width: 16rem; /* Default desktop width */
            }
            #main-content {
                margin-left: 16rem; /* Default desktop margin */
            }
            #mobile-backdrop, #mobile-header {
                display: none !important;
            }
            /* Show desktop toggle button */
            #sidebar .desktop-toggle-container {
                display: flex !important;
                align-items: center;
                justify-content: flex-end; /* Keep to the right when expanded */
            }
            /* When collapsed by default on desktop, apply collapsed styles */
            .sidebar-collapsed #sidebar {
                width: 5rem;
            }
            .sidebar-collapsed #main-content {
                margin-left: 5rem;
            }
            /* New rule for collapsed toggle button container: center it */
            .sidebar-collapsed .desktop-toggle-container {
                justify-content: center; /* Center horizontally when collapsed */
            }
            /* Ensure the toggle button itself is centered within its container when collapsed */
            .sidebar-collapsed #sidebar-toggle {
                display: flex;
                justify-content: center;
                align-items: center;
            }
        }

        /* Step indicator specific styles from image */
        .step-indicator-dots {
            display: flex;
            justify-content: flex-start; /* Align dots to the left */
            align-items: center;
            gap: 0.5rem; /* Space between dots */
        }
        .step-dot {
            width: 0.5rem; /* w-2 */
            height: 0.5rem; /* h-2 */
            background-color: #D1D5DB; /* gray-300 */
            border-radius: 9999px; /* rounded-full */
            transition: background-color 0.3s ease-in-out, width 0.3s ease-in-out;
        }
        .step-dot.active {
            background-color: #3B82F6; /* blue-500 */
            width: 1.5rem; /* Longer active dot */
        }

        /* Device grouping styles */
        .device-group {
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left-width: 4px; /* For the colored border */
        }
        .device-group-header {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .device-address-item {
            background-color: #F9FAFB; /* gray-50 */
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column; /* Stack name and address vertically */
            align-items: flex-start; /* Align text to the left */
            font-size: 0.875rem;
            color: #4B5563;
        }
        .address-primary-text {
            font-weight: 500;
            color: #1F2937;
        }
        .address-secondary-text {
            font-size: 0.75rem; /* text-xs */
            color: #6B7280; /* gray-500 */
            margin-top: 0.25rem; /* Space between primary and secondary */
        }
        .address-tertiary-text { /* New style for full expression */
            font-size: 0.7rem; /* even smaller text */
            color: #6B7280; /* gray-500 */
            margin-top: 0.25rem;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; /* Monospace font */
            white-space: pre-wrap; /* Preserve whitespace and wrap */
            word-break: break-all; /* Break long words */
        }
        .address-item-controls {
            margin-top: 0.5rem; /* Space between text and buttons */
            display: flex;
            gap: 0.5rem;
            width: 100%; /* Take full width to align buttons */
            justify-content: flex-end; /* Push buttons to the right */
        }

        /* Inline edit input style */
        .device-name-input {
            width: auto; /* Adjust width as needed */
            min-width: 100px;
            max-width: 80%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.25rem;
            font-weight: 600;
            font-size: 1rem;
            color: #1F2937;
        }
        .address-name-input {
            width: 100%; /* Take full width for editing */
            padding: 0.25rem 0.5rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            color: #1F2937;
            margin-bottom: 0.5rem; /* Space above buttons */
        }


        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* High z-index to be on top */
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
            max-height: 90vh; /* Limit height for smaller screens */
            overflow-y: auto; /* Enable scrolling if content overflows */
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 1rem;
        }
        .modal-body {
            margin-bottom: 1.5rem;
            flex-grow: 1; /* Allow body to take available space */
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            border-top: 1px solid #E5E7EB;
            padding-top: 1rem;
        }

        /* Custom dropdown styling for emphasis */
        .custom-select-container {
            position: relative;
        }

        .custom-select-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            /* Replicate original select styling */
            margin-top: 0.25rem; /* mt-1 */
            width: 100%; /* w-full */
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #D1D5DB; /* border-gray-300 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            font-size: 0.875rem; /* sm:text-sm */
            padding: 0.5rem; /* p-2 */
            background-color: #FFFFFF; /* bg-white */
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .custom-select-display:hover {
            border-color: #60A5FA; /* hover:border-blue-400 */
        }

        .custom-select-display.active,
        .custom-select-display:focus {
            border-color: #3B82F6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); /* focus:ring-blue-500 with opacity */
            outline: none; /* Remove default outline */
        }

        .custom-select-options {
            position: absolute;
            z-index: 10;
            width: 100%;
            background-color: white;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            margin-top: 0.25rem;
            max-height: 15rem; /* max-h-60 */
            overflow-y: auto;
            /* Ensure it's block when not hidden */
            display: none; /* Hidden by default */
        }
        .custom-select-options:not(.hidden) {
            display: block; /* Force display to block when 'hidden' class is removed */
        }


        .custom-select-option {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: #4B5563;
        }

        .custom-select-option:hover {
            background-color: #F3F4F6; /* gray-100 */
        }

        .custom-select-option.selected {
            background-color: #E0F2FE; /* blue-100 */
            color: #1D4ED8; /* blue-700 */
            font-weight: 500;
        }

        .custom-select-option.new-device-option-custom {
            background-color: #EFF6FF; /* blue-50 */
            color: #2563EB; /* blue-600 */
            font-weight: 600;
            border-top: 1px solid #DBEAFE; /* blue-100 */
        }
        .custom-select-option.new-device-option-custom:hover {
            background-color: #DBEAFE; /* blue-100 */
        }

        /* Tag blob styling */
        .tag-blob {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px; /* full rounded */
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* medium */
            margin-left: 0.75rem; /* ml-3 */
            line-height: 1; /* ensure vertical alignment */
        }
        .tag-expression {
            background-color: #E5E7EB; /* gray-200 */
            color: #4B5563; /* gray-700 */
        }
        .tag-modbus {
            background-color: #D1FAE5; /* green-100 */
            color: #065F46; /* green-800 */
        }
        .tag-function { /* New tag style for function names */
            background-color: #FEE2E2; /* red-100 */
            color: #991B1B; /* red-800 */
        }
        .tag-suggested-name { /* New tag style for suggested names */
            background-color: #FFEDD5; /* orange-100 */
            color: #9A3412; /* orange-800 */
        }
    </style>
</head>
<body class="bg-gray-100 h-full flex flex-col">
    <!-- Hidden div to ensure Tailwind JIT includes dynamic color classes -->
    <div class="hidden
        bg-blue-50 border-blue-400 text-blue-800
        bg-green-50 border-green-400 text-green-800
        bg-purple-50 border-purple-400 text-purple-800
        bg-orange-50 border-orange-400 text-orange-800
        bg-red-50 border-red-400 text-red-800
    "></div>

    <!-- Mobile Header (Visible only on small screens) -->
    <header id="mobile-header" class="bg-white shadow-md p-4 flex items-center justify-between md:hidden">
        <h1 class="text-xl font-bold text-gray-800">Dashboard</h1>
        <button id="mobile-hamburger" class="p-2 rounded-full hover:bg-gray-200 text-gray-800 focus:outline-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </header>

    <!-- Main Content Area with Sidebar -->
    <div id="dashboard-container" class="flex flex-grow sidebar-collapsed h-full">
        <!-- Sidebar Menu (Cloudflare inspired) -->
        <aside id="sidebar" class="bg-gray-900 text-gray-300 p-4 flex flex-col rounded-tr-lg rounded-br-lg shadow-lg">
            <!-- Toggle Button (Desktop only, hidden on mobile by default) -->
            <div class="flex justify-end mb-4 desktop-toggle-container hidden">
                <button id="sidebar-toggle" class="p-2 rounded-full hover:bg-gray-700 text-white focus:outline-none">
                    <span class="icon-emoji">▶️</span>
                </button>
            </div>

            <nav class="flex-grow">
                <ul>
                    <li class="mb-2">
                        <a href="#" data-page="configure-devices" class="sidebar-link flex items-center py-2 px-4 rounded-lg transition duration-200 ease-in-out">
                            <span class="mr-3 icon-emoji">⚙️</span>
                            <span class="sidebar-text">CODESYS Import</span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="/modbus-graph.html" class="sidebar-link flex items-center py-2 px-4 rounded-lg transition duration-200 ease-in-out">
                            <span class="mr-3 icon-emoji">📈</span>
                            <span class="sidebar-text">MODBUS Graph</span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="/settings.html" class="sidebar-link flex items-center py-2 px-4 rounded-lg transition duration-200 ease-in-out">
                            <span class="mr-3 icon-emoji">🔧</span>
                            <span class="sidebar-text">Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <!-- Optional: Add a user/account section at the bottom of the sidebar -->
            <div class="mt-auto pt-4 border-t border-gray-700">
                <div class="flex items-center p-2 rounded-lg hover:bg-gray-700 cursor-pointer transition duration-200 ease-in-out profile-pic-container">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                        JD
                    </div>
                    <div class="sidebar-text">
                        <p class="text-sm font-semibold text-white">John Doe</p>
                        <p class="text-xs text-gray-400">Admin</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Mobile Backdrop (Visible only when mobile sidebar is open) -->
        <div id="mobile-backdrop" class="hidden"></div>

        <!-- Content Area -->
        <main id="main-content" class="flex-grow p-6">
            <div class="container mx-auto px-4 py-8">
                <!-- Configure Devices Section (Step 2 - now primary content) -->
                <section id="configure-devices-section" class="dashboard-section">
                    <h2 class="text-3xl font-semibold text-gray-700 mb-6">Configure Devices & Addresses</h2>

                    <!-- Card for Step 2: Configure Devices -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <!-- Step Indicator (Dots) -->
                        <div class="step-indicator-dots flex justify-start items-center space-x-2 mb-8">
                            <div class="step-dot" data-step="1"></div>
                            <div class="step-dot active" data-step="2"></div>
                            <div class="step-dot" data-step="3"></div>
                        </div>

                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Step 2: Assign Addresses to Devices</h3>
                        <p class="text-gray-600 mb-6">Review the imported addresses and assign them to existing devices or create new ones.</p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Left Column: Unassigned Addresses -->
                            <div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-4">Unassigned Addresses</h4>
                                <div id="unassigned-addresses-list" class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-h-[150px]">
                                    <!-- Addresses will be dynamically loaded here -->
                                    <p class="text-gray-500 text-sm text-center py-4">No addresses to configure.</p>
                                </div>
                            </div>

                            <!-- Right Column: Device Configuration Form -->
                            <div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-4">Assign Address</h4>
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <div class="mb-4">
                                        <label for="device-select" class="block text-sm font-medium text-gray-700">Assign to Device:</label>
                                        <!-- Custom Dropdown for Device Selection -->
                                        <div class="custom-select-container">
                                            <div id="custom-device-select-display" class="custom-select-display">
                                                <span>-- Select or Create New --</span>
                                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                            </div>
                                            <input type="hidden" id="hidden-device-select-value" value="">
                                            <div id="custom-device-select-options" class="custom-select-options hidden">
                                                <!-- Options will be dynamically loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                    <button id="assign-address-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md">
                                        Assign Selected Addresses
                                    </button>
                                </div>
                            </div>
                        </div>

                        <h4 class="text-lg font-semibold text-gray-700 mt-8 mb-4">Configured Devices & Addresses</h4>
                        <div id="configured-devices-list" class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-h-[150px]">
                            <!-- Configured devices and their addresses will be rendered here -->
                            <p class="text-gray-500 text-sm text-center py-4">No devices configured yet.</p>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="flex justify-end items-center mt-8 pt-4 border-t border-gray-200">
                            <button id="step2-next-button" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-full hover:bg-blue-600 transition duration-300 ease-in-out shadow-md">
                                Finish Configuration
                            </button>
                        </div>
                        <form id="submit-form" action="/upload-23" method="POST" class="hidden">
                            <input type="hidden" name="addresses" id="addresses-input">
                            <input type="hidden" name="devices" id="devices-input">
                        </form>
                        <script>
                            document.addEventListener('DOMContentLoaded', function () {
                                const step2NextButton = document.getElementById('step2-next-button');
                                const submitForm = document.getElementById('submit-form');
                                const addressesInput = document.getElementById('addresses-input');
                                const devicesInput = document.getElementById('devices-input');

                                step2NextButton.addEventListener('click', function (e) {
                                    e.preventDefault();
                                    addressesInput.value = JSON.stringify(mockAddresses);
                                    devicesInput.value = JSON.stringify(devices);
                                    submitForm.submit();
                                });
                            });
                        </script>
                    </div>
                </section>

                <!-- MODBUS Graph Section (Now hidden by default and managed externally) -->
                <section id="modbus-graph-section" class="dashboard-section hidden">
                    <!-- This section is hidden and would typically be loaded via a separate Flask route -->
                </section>
            </div>
        </main>
    </div>

    <!-- New Device Modal -->
    <div id="new-device-modal-backdrop" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span class="device-name-display-modal cursor-pointer">New Device</span>
                <input type="text" class="device-name-input-modal hidden w-full text-xl font-semibold text-gray-800 p-1 border rounded" value="New Device">
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Device ID:</label>
                    <p id="modal-device-id" class="mt-1 text-gray-600 font-mono text-sm"></p>
                </div>
                <div class="mb-4">
                    <label for="modal-device-description" class="block text-sm font-medium text-gray-700">Description:</label>
                    <textarea id="modal-device-description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" placeholder="e.g., Main PLC for Production Line A"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="modal-cancel-button" class="px-4 py-2 text-gray-700 font-semibold rounded-full hover:bg-gray-100 transition duration-200 ease-in-out">
                    Cancel
                </button>
                <button id="modal-add-device-button" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-full hover:bg-blue-600 transition duration-200 ease-in-out shadow-md">
                    Add Device
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global data arrays - moved outside DOMContentLoaded to ensure immediate availability
        let mockAddresses = [];
        let devices = [];
        const deviceColors = ['blue', 'green', 'purple', 'orange', 'red']; // For distinct device colors
        let colorIndex = 0; // To cycle through device colors


        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded');

            const body = document.body;
            const dashboardContainer = document.getElementById('dashboard-container');
            const sidebarToggle = document.getElementById('sidebar-toggle'); // Desktop toggle
            const mobileHamburger = document.getElementById('mobile-hamburger'); // Mobile toggle
            const mobileBackdrop = document.getElementById('mobile-backdrop');
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const dashboardSections = document.querySelectorAll('.dashboard-section');
            const stepDots = document.querySelectorAll('.step-dot');

            // Step 2 Elements
            const configureDevicesSection = document.getElementById('configure-devices-section');
            const unassignedAddressesList = document.getElementById('unassigned-addresses-list');
            // Replaced deviceSelect with custom dropdown elements
            const customDeviceSelectDisplay = document.getElementById('custom-device-select-display');
            const hiddenDeviceSelectValue = document.getElementById('hidden-device-select-value');
            const customDeviceSelectOptions = document.getElementById('custom-device-select-options');
            const assignAddressButton = document.getElementById('assign-address-button');
            const configuredDevicesList = document.getElementById('configured-devices-list');
            const step2NextButton = document.getElementById('step2-next-button');

            // Modal Elements
            const newDeviceModalBackdrop = document.getElementById('new-device-modal-backdrop');
            const modalDeviceNameDisplay = newDeviceModalBackdrop.querySelector('.device-name-display-modal');
            const modalDeviceNameInput = newDeviceModalBackdrop.querySelector('.device-name-input-modal');
            const modalDeviceIdDisplay = document.getElementById('modal-device-id');
            const modalDeviceDescriptionInput = document.getElementById('modal-device-description');
            const modalCancelButton = document.getElementById('modal-cancel-button');
            const modalAddDeviceButton = document.getElementById('modal-add-device-button');


            // Helper function to generate random strings (for IDs)
            function generateRandomString(length) {
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0987654321';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                return result;
            }

            // Helper function to generate random device names
            function generateRandomDeviceName() {
                const adjectives = ['Happy', 'Bright', 'Quick', 'Smart', 'Silent', 'Golden', 'Iron', 'Digital'];
                const nouns = ['Sensor', 'Actuator', 'Gateway', 'Controller', 'Unit', 'Module', 'System', 'Engine'];
                const randomAdjective = adjectives[Math.floor(Math.random() * adjectives.length)];
                const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
                const randomNumber = Math.floor(Math.random() * 90) + 10; // 2-digit number
                return `${randomAdjective}${randomNoun}${randomNumber}`;
            }

            // API function to prefill groups
            function setupInitialData() {
                // Define initial devices (groups)
                mockAddresses = {{mockAddresses| tojson }};
                devices = {{devices| tojson }};


                // Ensure colorIndex is correctly set if devices are pre-filled
                colorIndex = devices.length;
            }


            // --- Helper Functions for Modal ---

            function openNewDeviceModal() {
                console.log('Opening new device modal.');
                newDeviceModalBackdrop.classList.remove('hidden');
                body.classList.add('overflow-hidden'); // Prevent scrolling body when modal is open

                // Populate default values
                const defaultName = generateRandomDeviceName();
                const defaultId = generateRandomString(8); // 8-character alphanumeric ID

                modalDeviceNameDisplay.textContent = defaultName;
                modalDeviceNameInput.value = defaultName;
                modalDeviceIdDisplay.textContent = defaultId;
                modalDeviceDescriptionInput.value = ''; // Clear description

                // Show input for editing name, hide display
                modalDeviceNameDisplay.classList.add('hidden');
                modalDeviceNameInput.classList.remove('hidden');
                modalDeviceNameInput.focus();

                // Ensure listeners are correctly set for modal name input
                // Remove existing listeners to prevent multiple bindings
                modalDeviceNameInput.removeEventListener('blur', saveModalDeviceName);
                modalDeviceNameInput.removeEventListener('keydown', handleModalNameInputKeydown);
                modalDeviceNameDisplay.removeEventListener('click', toggleModalNameEdit); // Remove previous click listener

                // Add new listeners
                modalDeviceNameInput.addEventListener('blur', saveModalDeviceName);
                modalDeviceNameInput.addEventListener('keydown', handleModalNameInputKeydown);
                modalDeviceNameDisplay.addEventListener('click', toggleModalNameEdit); // Add click listener for display
            }

            function saveModalDeviceName() {
                const newName = modalDeviceNameInput.value.trim();
                if (newName) {
                    modalDeviceNameDisplay.textContent = newName;
                } else {
                    modalDeviceNameInput.value = modalDeviceNameDisplay.textContent; // Revert if empty
                }
                modalDeviceNameDisplay.classList.remove('hidden');
                modalDeviceNameInput.classList.add('hidden');
            }

            function handleModalNameInputKeydown(e) {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Prevent form submission if it's a form
                    saveModalDeviceName();
                    modalDeviceNameInput.blur(); // Trigger blur to save
                }
            }

            function toggleModalNameEdit() {
                modalDeviceNameDisplay.classList.add('hidden');
                modalDeviceNameInput.classList.remove('hidden');
                modalDeviceNameInput.focus();
            }

            function closeNewDeviceModal() {
                console.log('Closing new device modal.');
                newDeviceModalBackdrop.classList.add('hidden');
                body.classList.remove('overflow-hidden');
                // Reset custom dropdown display and hidden value
                customDeviceSelectDisplay.querySelector('span').textContent = '-- Select or Create New --';
                hiddenDeviceSelectValue.value = '';
                customDeviceSelectOptions.classList.add('hidden'); // Hide options
            }

            // --- UI Management Functions ---

            // Function to update step indicator dots
            function updateStepIndicator(currentStep) {
                stepDots.forEach(dot => {
                    const step = parseInt(dot.dataset.step);
                    if (step === currentStep) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            }

            // Function to show a specific section and set active sidebar link
            function showSection(sectionId) {
                console.log(`Attempting to show section: ${sectionId}`);
                dashboardSections.forEach(section => {
                    section.classList.add('hidden'); // Hide all sections
                });

                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.remove('hidden'); // Show the target section
                    console.log(`Section "${sectionId}" shown.`);
                } else {
                    console.error(`Error: Section with ID "${sectionId}" not found.`);
                }
            }

            // Function to toggle sidebar for desktop (collapse/expand)
            function toggleDesktopSidebar() {
                dashboardContainer.classList.toggle('sidebar-collapsed');
                const isCollapsed = dashboardContainer.classList.contains('sidebar-collapsed');
                sidebarToggle.innerHTML = isCollapsed
                    ? '<span class="icon-emoji">▶️</span>' // Right arrow emoji
                    : '<span class="icon-emoji">◀️</span>'; // Left arrow emoji
            }

            // Function to toggle sidebar for mobile (open/close drawer)
            function toggleMobileSidebar() {
                body.classList.toggle('mobile-sidebar-open');
            }

            // --- Step 2 Specific Functions ---

            function renderUnassignedAddresses() {
                unassignedAddressesList.innerHTML = ''; // Clear previous list
                const unassigned = mockAddresses.filter(addr => addr.deviceId === null);

                if (unassigned.length === 0) {
                    unassignedAddressesList.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">All addresses configured!</p>';
                    return;
                }

                unassigned.forEach(address => {
                    const addressDiv = document.createElement('label'); // Use label for checkbox click area
                    addressDiv.className = 'bg-white rounded-md shadow-sm p-3 mb-2 flex items-center cursor-pointer hover:bg-blue-50 transition duration-150 ease-in-out';
                    
                    let primaryText = address.name;
                    let secondaryText = address.modbusAddress;
                    let tagsHtml = '';
                    let expressionDetailHtml = '';

                    if (address.type === 'Expression') {
                        tagsHtml += `<span class="tag-blob tag-expression">Expression</span>`;
                        if (address.functionName) {
                            tagsHtml += `<span class="tag-blob tag-function">${address.functionName}</span>`;
                        }
                        if (address.suggestedName) {
                            tagsHtml += `<span class="tag-blob tag-suggested-name">${address.suggestedName}</span>`;
                        }
                        expressionDetailHtml = `<span class="address-tertiary-text">${address.fullExpression}</span>`;
                    } else { // MODBUS type
                        tagsHtml += `<span class="tag-blob tag-modbus">MODBUS</span>`;
                    }

                    addressDiv.innerHTML = `
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 mr-3" data-address-id="${address.id}">
                        <div class="flex justify-between items-center flex-grow">
                            <div class="flex flex-col">
                                <span class="address-primary-text">${primaryText}</span>
                                <span class="address-secondary-text">${secondaryText}</span>
                                ${expressionDetailHtml}
                            </div>
                            <div class="flex flex-wrap gap-1">
                                ${tagsHtml}
                            </div>
                        </div>
                    `;
                    unassignedAddressesList.appendChild(addressDiv);
                });
            }

            function renderDeviceSelectOptions() {
                // Clear existing options, but keep the "Create New Device" option
                customDeviceSelectOptions.innerHTML = ''; // Clear all to re-add
                
                // Add "Create New Device" option first
                const newDeviceOption = document.createElement('div');
                newDeviceOption.className = 'custom-select-option new-device-option-custom';
                newDeviceOption.dataset.value = 'new-device';
                newDeviceOption.textContent = 'Create New Device';
                customDeviceSelectOptions.appendChild(newDeviceOption);

                devices.forEach(device => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'custom-select-option';
                    optionDiv.dataset.value = device.id;
                    optionDiv.innerHTML = `<span>${device.name}</span><span class="text-gray-500 text-xs">${device.id}</span>`;
                    customDeviceSelectOptions.appendChild(optionDiv);
                });

                // Add click listeners to the new options
                customDeviceSelectOptions.querySelectorAll('.custom-select-option').forEach(option => {
                    option.addEventListener('click', (event) => {
                        const selectedValue = event.currentTarget.dataset.value;
                        let selectedText;

                        if (selectedValue === 'new-device') {
                            selectedText = event.currentTarget.textContent; // Get text directly for "Create New Device"
                            openNewDeviceModal();
                            // Reset display to default after opening modal
                            customDeviceSelectDisplay.querySelector('span').textContent = '-- Select or Create New --';
                            hiddenDeviceSelectValue.value = '';
                        } else {
                            selectedText = event.currentTarget.querySelector('span:first-child').textContent; // Get the name part
                            customDeviceSelectDisplay.querySelector('span').textContent = selectedText;
                            hiddenDeviceSelectValue.value = selectedValue;
                        }
                        customDeviceSelectOptions.classList.add('hidden'); // Hide options after selection
                        customDeviceSelectDisplay.classList.remove('active'); // Remove active state
                    });
                });
            }

            function renderConfiguredDevices() {
                configuredDevicesList.innerHTML = ''; // Clear previous list

                if (devices.length === 0) {
                    configuredDevicesList.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No devices configured yet.</p>';
                    return;
                }

                devices.forEach(device => {
                    const deviceGroupDiv = document.createElement('div');
                    // Use a more robust way to get color class, e.g., `bg-${device.color}-50`
                    deviceGroupDiv.className = `device-group bg-${device.color}-50 border-l-${device.color}-400 text-${device.color}-800 shadow-sm`;
                    deviceGroupDiv.innerHTML = `
                        <div class="device-group-header">
                            <span class="device-name-display cursor-pointer" data-device-id="${device.id}">${device.name} <span class="text-gray-500 text-sm">${device.id}</span></span>
                            <input type="text" class="device-name-input hidden" value="${device.name}" data-device-id="${device.id}">
                            <button data-device-id="${device.id}" class="edit-device-name-btn text-gray-600 hover:text-gray-900 text-xs font-semibold ml-2">Edit</button>
                        </div>
                        <div class="device-addresses"></div>
                    `;
                    const addressesContainer = deviceGroupDiv.querySelector('.device-addresses');
                    
                    const associatedAddresses = mockAddresses.filter(addr => addr.deviceId === device.id);
                    if (associatedAddresses.length === 0) {
                        addressesContainer.innerHTML = '<p class="text-gray-600 text-sm mt-2">No addresses assigned to this device yet.</p>';
                    } else {
                        associatedAddresses.forEach(address => {
                            const addressItem = document.createElement('div');
                            addressItem.className = 'device-address-item';
                            
                            let primaryText = address.name;
                            let secondaryText = address.modbusAddress;
                            let tagsHtml = '';
                            let expressionDetailHtml = '';

                            if (address.type === 'Expression') {
                                tagsHtml += `<span class="tag-blob tag-expression">Expression</span>`;
                                if (address.functionName) {
                                    tagsHtml += `<span class="tag-blob tag-function">${address.functionName}</span>`;
                                }
                                if (address.suggestedName) {
                                    tagsHtml += `<span class="tag-blob tag-suggested-name">${address.suggestedName}</span>`;
                                }
                                expressionDetailHtml = `<span class="address-tertiary-text">${address.fullExpression}</span>`;
                            } else { // MODBUS type
                                tagsHtml += `<span class="tag-blob tag-modbus">MODBUS</span>`;
                            }

                            addressItem.innerHTML = `
                                <div class="flex justify-between items-center w-full">
                                    <div class="flex flex-col">
                                        <span class="address-name-display address-primary-text" data-address-id="${address.id}">${primaryText}</span>
                                        <span class="address-secondary-text">${secondaryText}</span>
                                        ${expressionDetailHtml}
                                    </div>
                                    <div class="flex flex-wrap gap-1">
                                        ${tagsHtml}
                                    </div>
                                </div>
                                <input type="text" class="address-name-input hidden" value="${address.name}" data-address-id="${address.id}">
                                <div class="address-item-controls">
                                    <button data-address-id="${address.id}" class="edit-address-name-btn text-gray-600 hover:text-gray-900 text-xs font-semibold">Edit</button>
                                    <button data-address-id="${address.id}" class="remove-address-btn text-red-500 hover:text-red-700 text-xs font-semibold">Remove</button>
                                </div>
                            `;
                            addressesContainer.appendChild(addressItem);
                        });
                    }
                    configuredDevicesList.appendChild(deviceGroupDiv);
                });

                // Add event listeners for remove address buttons
                configuredDevicesList.querySelectorAll('.remove-address-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const addressId = event.target.dataset.addressId;
                        const addressIndex = mockAddresses.findIndex(addr => addr.id === addressId);
                        if (addressIndex !== -1) {
                            mockAddresses[addressIndex].deviceId = null;
                            mockAddresses[addressIndex].deviceName = null;
                            renderUnassignedAddresses();
                            renderDeviceSelectOptions();
                            renderConfiguredDevices();
                        }
                    });
                });

                // Add event listeners for inline edit device name
                configuredDevicesList.querySelectorAll('.edit-device-name-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const deviceId = event.target.dataset.deviceId;
                        const deviceGroup = event.target.closest('.device-group');
                        const displayName = deviceGroup.querySelector('.device-name-display');
                        const editInput = deviceGroup.querySelector('.device-name-input');

                        displayName.classList.add('hidden');
                        editInput.classList.remove('hidden');
                        editInput.focus();

                        const saveName = () => {
                            const newName = editInput.value.trim();
                            if (newName && newName !== displayName.textContent.trim()) {
                                const deviceToEdit = devices.find(dev => dev.id === deviceId);
                                if (deviceToEdit) {
                                    deviceToEdit.name = newName;
                                    // Update associated addresses' deviceName as well
                                    mockAddresses.forEach(addr => {
                                        if (addr.deviceId === deviceId) {
                                            addr.deviceName = newName;
                                        }
                                    });
                                    renderConfiguredDevices(); // Re-render to show updated name
                                    renderDeviceSelectOptions(); // Update dropdown
                                }
                            } else {
                                // If name is empty or unchanged, revert to original display
                                renderConfiguredDevices();
                            }
                        };

                        editInput.addEventListener('blur', saveName, { once: true });
                        editInput.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault(); // Prevent form submission
                                editInput.blur(); // Trigger blur to save
                            }
                        }, { once: true });
                    });
                });

                // Add event listeners for inline edit address name
                configuredDevicesList.querySelectorAll('.edit-address-name-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const addressId = event.target.dataset.addressId;
                        const addressItem = event.target.closest('.device-address-item');
                        const displayName = addressItem.querySelector('.address-name-display');
                        const editInput = addressItem.querySelector('.address-name-input');

                        displayName.classList.add('hidden');
                        editInput.classList.remove('hidden');
                        editInput.focus();

                        const saveAddressName = () => {
                            const newName = editInput.value.trim();
                            if (newName && newName !== displayName.textContent.trim()) {
                                const addressToEdit = mockAddresses.find(addr => addr.id === addressId);
                                if (addressToEdit) {
                                    addressToEdit.name = newName;
                                    renderConfiguredDevices(); // Re-render to show updated name
                                    renderUnassignedAddresses(); // Update unassigned list if it was there
                                }
                            } else {
                                // If name is empty or unchanged, revert to original display
                                renderConfiguredDevices();
                            }
                        };

                        // Remove existing listeners to prevent multiple bindings
                        editInput.removeEventListener('blur', saveAddressName);
                        editInput.removeEventListener('keydown', handleAddressNameInputKeydown);

                        // Add new listeners
                        editInput.addEventListener('blur', saveAddressName);
                        editInput.addEventListener('keydown', handleAddressNameInputKeydown);
                    });
                });

                // Handler for address name input keydown (for Enter key)
                function handleAddressNameInputKeydown(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Prevent form submission
                        e.target.blur(); // Trigger blur to save
                    }
                }
            }

            // --- Event Listeners ---

            // Sidebar links
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    event.currentTarget.classList.add('active');

                    const pageId = event.currentTarget.dataset.page;
                    if (pageId) {
                        event.preventDefault();
                        showSection(`${pageId}-section`);
                        if (body.classList.contains('mobile-sidebar-open')) {
                            toggleMobileSidebar();
                        }
                        // Update step indicator based on the section shown
                        if (pageId === 'configure-devices') {
                            updateStepIndicator(2);
                        }
                    }
                });
            });

            // Desktop sidebar toggle
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleDesktopSidebar);
            }
            // Mobile hamburger and backdrop
            if (mobileHamburger) {
                mobileHamburger.addEventListener('click', toggleMobileSidebar);
            }
            if (mobileBackdrop) {
                mobileBackdrop.addEventListener('click', toggleMobileSidebar);
            }

            // Step 2 "Finish Configuration" button click (placeholder)
            step2NextButton.addEventListener('click', () => {
                // In a real app, you would send 'devices' and 'mockAddresses' data to Flask
            });

            // Custom Dropdown Event Listeners
            customDeviceSelectDisplay.addEventListener('click', () => {
                customDeviceSelectOptions.classList.toggle('hidden');
                customDeviceSelectDisplay.classList.toggle('active');
            });

            // Close custom dropdown when clicking outside
            document.addEventListener('click', (event) => {
                // Check if the click is outside the custom select container AND not inside the new device modal
                const isClickInsideCustomSelect = event.target.closest('.custom-select-container');
                const isClickInsideModal = event.target.closest('#new-device-modal-backdrop');

                if (!isClickInsideCustomSelect && !isClickInsideModal) {
                    customDeviceSelectOptions.classList.add('hidden');
                    customDeviceSelectDisplay.classList.remove('active');
                }
            });


            // Modal Buttons
            modalCancelButton.addEventListener('click', closeNewDeviceModal);
            modalAddDeviceButton.addEventListener('click', () => {
                const newDeviceName = modalDeviceNameInput.value.trim();
                const newDeviceId = modalDeviceIdDisplay.textContent;
                const newDeviceDescription = modalDeviceDescriptionInput.value.trim();

                if (!newDeviceName) {
                    return;
                }

                // Check if device ID already exists (should be unique)
                if (devices.some(dev => dev.id === newDeviceId)) {
                    // Regenerate ID or prompt user
                    modalDeviceIdDisplay.textContent = generateRandomString(8);
                    return;
                }

                const newColor = deviceColors[colorIndex % deviceColors.length];
                devices.push({
                    id: newDeviceId,
                    name: newDeviceName,
                    description: newDeviceDescription,
                    color: newColor
                });
                colorIndex++; // Cycle through colors
                console.log('New device added:', devices[devices.length - 1]);

                closeNewDeviceModal();
                renderDeviceSelectOptions();
                renderConfiguredDevices(); // Re-render to show the new device
                // Select the newly created device in the custom dropdown
                customDeviceSelectDisplay.querySelector('span').textContent = newDeviceName;
                hiddenDeviceSelectValue.value = newDeviceId;
            });


            // Assign Addresses button click in Step 2
            assignAddressButton.addEventListener('click', () => {
                console.log('Assign Addresses button clicked.');
                const selectedAddressCheckboxes = unassignedAddressesList.querySelectorAll('input[type="checkbox"]:checked');
                
                if (selectedAddressCheckboxes.length === 0) {
                    return;
                }

                let deviceId = hiddenDeviceSelectValue.value; // Get value from hidden input
                let deviceName = '';

                if (deviceId === 'new-device' || deviceId === '') {
                    return;
                } else {
                    // Existing device, get its name
                    const selectedDevice = devices.find(dev => dev.id === deviceId);
                    if (selectedDevice) {
                        deviceName = selectedDevice.name;
                        console.log(`Selected existing device: ${deviceName} (ID: ${deviceId})`);
                    } else {
                        console.error(`Error: Selected device with ID "${deviceId}" not found in devices array.`);
                        return;
                    }
                }

                selectedAddressCheckboxes.forEach(checkbox => {
                    const addressId = checkbox.dataset.addressId;
                    const addressToAssign = mockAddresses.find(addr => addr.id === addressId);
                    if (addressToAssign) {
                        addressToAssign.deviceId = deviceId;
                        addressToAssign.deviceName = deviceName;
                        console.log(`Assigned address "${addressToAssign.name}" to device "${deviceName}".`);
                    } else {
                        console.error(`Error: Address with ID "${addressId}" not found in mockAddresses.`);
                    }
                });

                // Clear selected checkboxes and re-render lists
                selectedAddressCheckboxes.forEach(checkbox => checkbox.checked = false);
                customDeviceSelectDisplay.querySelector('span').textContent = '-- Select or Create New --'; // Reset custom dropdown display
                hiddenDeviceSelectValue.value = ''; // Reset hidden value

                renderUnassignedAddresses();
                renderDeviceSelectOptions();
                renderConfiguredDevices();
                console.log('UI re-rendered after assignment.');
                console.log('Current mockAddresses state:', mockAddresses);
                console.log('Current devices state:', devices);
            });


            // Initial setup on load
            setupInitialData(); // Call the API to prefill data
            showSection('configure-devices-section'); // Start directly on step 2
            updateStepIndicator(2); // Set step indicator to 2
            const codesysLink = document.querySelector('[data-page="configure-devices"]'); // Link for this page
            if (codesysLink) {
                codesysLink.classList.add('active');
            }
            renderUnassignedAddresses(); // Render initial state of addresses
            renderDeviceSelectOptions(); // Render initial state of device options
            renderConfiguredDevices(); // Render initial state of configured devices
        });
    </script>
</body>
</html>
